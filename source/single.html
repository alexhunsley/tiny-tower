<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bell Player + Place Notation (modular)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <style>
    /* inline highlight style to be bullet-proof */
    #notationOutput .row-item { padding: 2px 6px; border-radius: 6px; }
    #notationOutput .row-item.playing { background-color: #1e293b !important; }
  </style>
<style>
:root { --bg:#0f172a; --panel:#111827; --accent:#60a5fa; --muted:#94a3b8; --text:#e5e7eb; }

* { box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
html, body { height:100%; }
body { margin:0; background:linear-gradient(180deg,#0b1023,#0f172a); color:var(--text); }

/* Layout: app fills viewport, toolbar sticks, workspace expands */
.app { min-height:100vh; display:flex; flex-direction:column; }

/* Sticky header with its own background so content doesn't "jump" */
.toolbar {
  position: sticky;
  top: 0;
  z-index: 20;
  background: var(--panel);
  border-bottom: 1px solid #1f2937;
  box-shadow: 0 2px 12px rgba(0,0,0,.25);
}
.toolbar .bar { width:min(1000px, 96vw); margin:0 auto; padding:16px 0; }
.toolbar h1 { margin:0 0 8px; font-size:1.1rem; }
.toolbar p { margin:0 0 12px; color:var(--muted); }

/* Workspace uses all remaining vertical space */
.workspace {
  flex: 1 1 auto;
  display: flex;
  justify-content: center;
  padding: 12px 0 16px;
}
.panel {
  width:min(1000px, 96vw);
  border:1px solid #273244; background:#0b1220;
  border-radius:12px; padding:12px;
  display:flex; flex-direction:column;
  min-height: 0; /* allow child to control overflow */
}

/* Generated rows list fills panel and scrolls */
#notationOutput {
  flex: 1 1 auto;
  overflow: auto;
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  font-size: 0.95rem; line-height: 1.4;
}

/* Common UI bits */
.row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:.5rem 0; }

input[type="text"], input[type="number"]{
  padding:12px; border-radius:10px; border:1px solid #303949; background:#0b1220; color:var(--text); font-weight:600;
}
input[type="number"] { width:100px; }
input::placeholder { color:#6b778d; }

button { appearance:none; border:none; padding:12px 14px; border-radius:10px; font-weight:800; cursor:pointer; letter-spacing:.01em; }
.primary { background:var(--accent); color:#0b1023; }
.secondary { background:#1f2937; color:var(--text); }
.ghost { background:#0b1220; border:1px solid #2a3550; color:#cfe1ff; }
button:disabled { opacity:.55; cursor:not-allowed; }

.pill { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #2a3550; background:#0b1220; color:#9fb5d1; font-size:.8rem; }
label { font-size:.9rem; color:#a8b0bf; }
input[type="range"] { width:160px; }
.rule { border:none; border-top:1px solid #273244; margin:10px 0; }

/* highlight (also defined inline in index.html for cache-proofing) */
#notationOutput .row-item { padding: 2px 6px; border-radius: 6px; }
#notationOutput .row-item.playing { background: #1e293b; }
</style>
</head>
<body>
  <div class="app">

    <!-- Sticky toolbar at the very top -->
    <header class="toolbar">
      <div class="bar">
        <h1>üîî Tiny Tower</h1>
        <!-- <p class="muted">Enter digits 1‚Äì8 (1 is the highest note). Set Place Notation and Stage, then Generate. Playback adds a cover on odd stages only during audio.</p> -->

        <!-- PLAYER CONTROLS -->
        <div class="row">
          <input id="seq" type="text" placeholder="Digits 1‚Äì8, e.g. 12345678 or 152531" inputmode="numeric" />
          <button id="play" class="primary">‚ñ∂Ô∏è Play</button>
          <button id="stop" class="secondary">‚èπ Stop</button>
          <button id="beep" class="ghost">üîä Test Beep</button>
          <span id="status" class="pill">idle</span>
        </div>

        <div class="row">
          <label>Tempo (BPM) <input id="bpm" type="number" min="30" max="300" value=""></label>
          <label>Strike (s) <input id="len" type="number" min="0.1" max="3" step="0.05" value=""></label>
          <label>Volume <input id="vol" type="range" min="0" max="1" step="0.01" value=""></label>
        </div>

        <hr class="rule">

        <!-- PLACE NOTATION + STAGE -->
        <div class="row">
          <input id="placeNotation" type="text"
                 value=""
                 placeholder="Place Notation (e.g. x12.16.34x)"
                 style="flex:1 1 320px">
          <label>Stage
            <input id="stage" type="number" min="4" max="12" step="1" value="" />
          </label>
          <button id="generate" class="primary">Generate</button>

          <!-- Generated rows playback -->
          <button id="playRows" class="secondary" title="Play generated rows">‚ñ∂Ô∏è Play Rows</button>
          <button id="pauseRows" class="ghost" title="Pause playback">‚è∏ Pause</button>
          <button id="stopRows" class="ghost" title="Stop playback">‚èπ Stop</button>
        </div>
      </div>
    </header>

    <!-- Workspace fills all remaining viewport height -->
    <main class="workspace">
      <div class="panel">
        <div id="notationOutput"><em class="muted">‚Äî nothing generated yet ‚Äî</em></div>
      </div>
    </main>
  </div>

  
<script>
(()=>{var w={stage:6,placeNotation:"x16x16x16x16x16x12",bpm:224,strike:1,volume:.9,autoGenerateOnLoad:!1,startHighlightAtRow0:!0};var u=null,h=null,y=[392,349.23,329.63,293.66,261.63,246.94,220,196,174.61,164.81,146.83,130.81];async function $(t,{strike:e=.6,volume:s=.9}={}){if(t<1||t>y.length)return;await k(s),x(s);let n=y[t-1]*1.5,i=Math.max(.05,Math.min(3,e)),r=u?u.currentTime:0,l=u.createOscillator(),o=u.createGain();l.type="sine",l.frequency.value=n;let p=Math.min(.005,i*.1),f=r,E=f+p,O=f+i;o.gain.setValueAtTime(1e-4,f),o.gain.linearRampToValueAtTime(1,E),o.gain.exponentialRampToValueAtTime(1e-4,O),l.connect(o).connect(h),l.start(f),l.stop(O+.01)}async function k(t=.9){(!u||u.state==="closed")&&(u=new(window.AudioContext||window.webkitAudioContext),h=u.createGain(),h.gain.value=Number.isFinite(t)?t:.9,h.connect(u.destination));try{await u.resume()}catch{}return u}function x(t){if(!u||!h)return;let e=u.currentTime;h.gain.setTargetAtTime(Math.max(0,Math.min(1,t)),e,.01)}function N(){if(!u)return;let t=u.currentTime;h.gain.setTargetAtTime(1e-4,t,.02),setTimeout(()=>{try{u.close()}catch{}u=null,h=null},120)}async function C(){if(u&&u.state==="running")try{await u.suspend()}catch{}}async function D(){if(u&&u.state==="suspended")try{await u.resume()}catch{}}function F(t,e,s){let n=u.createOscillator(),i=u.createGain();n.type="sine",n.frequency.value=t;let r=Math.min(.005,s*.1),l=.01,o=e,p=o+r,f=o+s;i.gain.setValueAtTime(1e-4,o),i.gain.linearRampToValueAtTime(1,p),i.gain.exponentialRampToValueAtTime(1e-4,f),n.connect(i).connect(h),n.start(o),n.stop(f+l)}async function V(t,{bpm:e=224,strike:s=.6,volume:n=.9}={}){if(!Array.isArray(t)||!t.length)return;await k(n),x(n);let i=60/Math.max(30,Math.min(300,e)),r=Math.max(.05,Math.min(3,s)),l=u.currentTime+.05;t.forEach((o,p)=>{if(o<1||o>y.length)return;let f=l+p*i,E=1.5*y[o-1];F(E,f,r)})}async function G(){await k();let t=u.currentTime+.02;F(880,t,.25)}function U(t){let e=String(t||"").replace(/\s+/g,"");return e?/^[1-8]+$/.test(e)?e.split("").map(s=>parseInt(s,10)):null:[]}var A="1234567890ET";function d(t){let e=Number(t);return Math.max(4,Math.min(12,Number.isFinite(e)?e:6))}function _(t){let e=d(t);return A.substring(0,e)}function I(t){let e=String(t||"").trim();if(!e)return[];let s=new Set([...A,"e","t","E","T"]),n=[],i="",r=()=>{i&&(n.push(i),i="")};for(let l=0;l<e.length;l++){let o=e[l];if(o==="."){r();continue}if(o==="x"||o==="X"){r(),n.push("x");continue}if(!/\s/.test(o)&&s.has(o)){i+=o==="e"?"E":o==="t"?"T":o;continue}}return r(),n}function Q(t){let e=String(t||"").trim();if(!e)return[];if(!e.includes(","))return I(e);let s=e.split(",").map(i=>i.trim()).filter(Boolean),n=[];for(let i of s){let r=I(i);if(!r.length)continue;let l=r.slice(0,-1).reverse();n.push(...r,...l)}return n}function R(t){let e=A.indexOf(t);return e>=0?e+1:null}function W(t,e,s){let n=t.length,i=t.split(""),r=i.slice();if(e==="x"){for(let p=0;p+1<n;p+=2)r[p]=i[p+1],r[p+1]=i[p];return r.join("")}let l=new Set;for(let p of e){let f=R(p);f&&f>=1&&f<=s&&l.add(f)}let o=1;for(;o<=n;){let p=o+1;if(l.has(o)){r[o-1]=i[o-1],o+=1;continue}if(p>n){r[o-1]=i[o-1],o+=1;continue}if(l.has(p)){r[o-1]=i[o-1],o+=1;continue}r[o-1]=i[p-1],r[p-1]=i[o-1],o+=2}return r.join("")}function T({pnString:t,stage:e,maxLeads:s=12}){let n=d(e),i=_(n),r=Q(t);if(!r.length)return[i];let l=[i],o=i,p=0;for(;p<s;){for(let f of r)o=W(o,f,n),l.push(o);if(p+=1,o===i)break}return l}function a(t){let e=document.getElementById(t);if(!e)throw new Error(`Element #${t} not found. Check index.html IDs and cache.`);return e}function X(){let t=new URLSearchParams(location.search),e=t.get("pn")||"",s=t.get("st"),n=s!=null?Number(s):null;return{pn:e,stage:n}}function P({pn:t,stage:e}){let s=new URLSearchParams(location.search);t&&t.trim()?s.set("pn",t.trim()):s.delete("pn"),s.set("st",String(d(e)));let n=`${location.pathname}?${s.toString()}${location.hash}`;history.replaceState(null,"",n)}function Y(){a("placeNotation").value||(a("placeNotation").value=w.placeNotation),a("stage").value||(a("stage").value=w.stage),a("bpm").value||(a("bpm").value=w.bpm),a("len").value||(a("len").value=w.strike),a("vol").value||(a("vol").value=w.volume)}function J(t,e=250){let s;return(...n)=>{clearTimeout(s),s=setTimeout(()=>t(...n),e)}}var j=J(P,250);function g(t){a("status").textContent=t}function b(){document.querySelectorAll("#notationOutput .row-item.playing").forEach(t=>t.classList.remove("playing"))}function K(t){let e=`#notationOutput .row-item[data-row="${t}"]`,s=document.querySelector(e);if(!s){console.debug("highlightRow: element not found for index",t,"selector:",e);return}b(),s.classList.add("playing"),s.scrollIntoView({block:"nearest",inline:"nearest"})}var M=!1,q=null;function L({playing:t}){a("play").disabled=!!t}function Z(){a("play").addEventListener("click",async()=>{if(M)return;let t=U(a("seq").value);if(t===null){g("invalid (use digits 1\u20138)");return}if(!t.length){g("nothing to play");return}let e=Math.max(30,Math.min(300,Number(a("bpm").value)||224)),s=Math.max(.05,Math.min(3,Number(a("len").value)||.6)),n=Math.max(0,Math.min(1,Number(a("vol").value)||.9));M=!0,L({playing:!0}),await V(t,{bpm:e,strike:s,volume:n}),g(`playing (${t.length} notes @ ${e} BPM)`);let i=60/e,r=(t.length*i+.2)*1e3;clearTimeout(q),q=setTimeout(()=>{M=!1,L({playing:!1}),g("idle")},r)}),a("stop").addEventListener("click",()=>{N(),M=!1,clearTimeout(q),L({playing:!1}),g("stopped")}),a("beep").addEventListener("click",async()=>{await G(),g("beep")}),a("vol").addEventListener("input",t=>{let e=Math.max(0,Math.min(1,Number(t.target.value)||.9));x(e)}),a("seq").value="12345678",L({playing:!1})}var m=[],c={playing:!1,paused:!1,abort:!1};function v({playing:t,paused:e}){a("playRows").disabled=!!t&&!e,a("pauseRows").disabled=!t||e,a("stopRows").disabled=!t}function B(t){let e=a("notationOutput");if(!t||!t.length){e.innerHTML='<em class="muted">\u2014 nothing generated \u2014</em>';return}let s=d(a("stage").value);e.innerHTML=t.map((n,i)=>`<div class="row-item" data-row="${i}"><code>${n.slice(0,s)}</code></div>`).join(""),requestAnimationFrame(()=>{})}function tt(){a("placeNotation").addEventListener("input",()=>{j({pn:a("placeNotation").value,stage:a("stage").value})}),a("stage").addEventListener("input",()=>{let t=d(a("stage").value);a("stage").value=t,j({pn:a("placeNotation").value,stage:t})}),a("generate").addEventListener("click",()=>{let t=(a("placeNotation").value||"").trim(),e=d(a("stage").value);a("stage").value=e,m=T({pnString:t,stage:e}),B(m),b(),P({pn:t,stage:e})}),a("playRows").addEventListener("click",async()=>{if(!(c.playing&&!c.paused)){if(!m.length){let t=d(a("stage").value);m=T({pnString:(a("placeNotation").value||"").trim(),stage:t}),B(m),b(),P({pn:a("placeNotation").value,stage:t})}if(m.length){if(c.paused){c.paused=!1,v({playing:!0,paused:!1}),await D();return}c.playing=!0,c.paused=!1,c.abort=!1,v({playing:!0,paused:!1}),nt().catch(t=>console.error(t))}}}),a("pauseRows").addEventListener("click",async()=>{!c.playing||c.paused||(c.paused=!0,v({playing:!0,paused:!0}),await C())}),a("stopRows").addEventListener("click",()=>{c.playing&&(c.abort=!0,c.paused=!1,c.playing=!1,v({playing:!1,paused:!1}),N(),b(),g("stopped"))}),v({playing:!1,paused:!1})}function et(t,e){let s=e%2===0?e:e+1,n=12-s,i=[];for(let r of t){let l=R(r);if(!l||l<1||l>e)continue;let o=n+l;o>=1&&o<=12&&i.push(o)}if(e%2===1){let r=n+s;r>=1&&r<=12&&i.push(r)}return i}function S(t){return new Promise(e=>setTimeout(e,t))}async function H(t,e){let s=0,n=performance.now();for(;s<t;){if(e("abort"))return;for(;e("paused");){if(await S(60),e("abort"))return;n=performance.now()}await S(20);let i=performance.now(),r=(i-n)/1e3;n=i;let o=60/Math.max(30,Math.min(300,Number(a("bpm").value)||224));s+=r/o}}async function nt(){let t=d(a("stage").value),e=Math.max(0,Math.min(1,Number(a("vol").value)||.9)),s=n=>n==="abort"?c.abort:n==="paused"?c.paused:c.abort||c.paused;for(let n=0;n<m.length&&!c.abort;n++){for(;c.paused&&(await S(60),!c.abort););if(c.abort)break;K(n),console.debug("Playing row",n,m[n]);let i=m[n],r=et(i,t);for(let l=0;l<r.length&&!c.abort;l++){for(;c.paused&&(await S(60),!c.abort););if(c.abort)break;let o=Math.max(.05,Math.min(3,Number(a("len").value)||.6));await $(r[l],{strike:o,volume:e}),l<r.length-1&&await H(1,s)}if(g(`row ${n+1}/${m.length}`),n<m.length-1){let l=n%2===0?2:1;await H(l,s)}}b(),c.abort||g("done"),c.playing=!1,c.paused=!1,c.abort=!1,v({playing:!1,paused:!1})}function z(){try{["seq","play","stop","beep","status","bpm","len","vol","placeNotation","stage","generate","notationOutput","playRows","pauseRows","stopRows"].forEach(s=>a(s));let{pn:t,stage:e}=X();if(t&&(a("placeNotation").value=t),e!=null&&(a("stage").value=d(e)),Y(),t||e!=null||w.autoGenerateOnLoad){let s=d(a("stage").value);m=T({pnString:(a("placeNotation").value||"").trim(),stage:s}),B(m),b()}Z(),tt(),window.addEventListener("resize",()=>requestAnimationFrame(updateBlueTrace)),a("notationOutput").addEventListener("scroll",()=>requestAnimationFrame(updateBlueTrace)),g("idle")}catch(t){console.error(t),alert(t.message+`

Tip: hard-reload (Ctrl+F5 / Cmd+Shift+R) to bust cache.`)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",z,{once:!0}):z();})();

</script>
</body>
</html>