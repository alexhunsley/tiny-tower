<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Bell Player + Place Notation (modular)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <style>
    /* inline highlight style to be bullet-proof */
    #notationOutput .row-item { padding: 2px 6px; border-radius: 6px; }
    #notationOutput .row-item.playing { background-color: #1e293b !important; }
  </style>
<style>
:root { --bg:#0f172a; --panel:#111827; --accent:#60a5fa; --muted:#94a3b8; --text:#e5e7eb; }

* { box-sizing:border-box; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
html, body { height:100%; }
body { margin:0; background:linear-gradient(180deg,#0b1023,#0f172a); color:var(--text); }

/* Layout: app fills viewport, toolbar sticks, workspace expands */
.app { min-height:100vh; display:flex; flex-direction:column; }

/* Sticky header with its own background so content doesn't "jump" */
.toolbar {
  position: sticky;
  top: 0;
  z-index: 20;
  background: var(--panel);
  border-bottom: 1px solid #1f2937;
  box-shadow: 0 2px 12px rgba(0,0,0,.25);
}
.toolbar .bar { width:min(1000px, 96vw); margin:0 auto; padding:16px 0; }
.toolbar h1 { margin:0 0 8px; font-size:1.1rem; }
.toolbar p { margin:0 0 12px; color:var(--muted); }

/* Workspace uses all remaining vertical space */
.workspace {
  flex: 1 1 auto;
  display: flex;
  justify-content: center;
  padding: 12px 0 16px;
}
.panel {
  width:min(1000px, 96vw);
  border:1px solid #273244; background:#0b1220;
  border-radius:12px; padding:12px;
  display:flex; flex-direction:column;
  min-height: 0; /* allow child to control overflow */
}

/* Generated rows list fills panel and scrolls */
#notationOutput {
  flex: 1 1 auto;
  overflow: auto;
  font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  font-size: 0.95rem; line-height: 1.4;
}

/* Common UI bits */
.row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:.5rem 0; }

input[type="text"], input[type="number"]{
  padding:12px; border-radius:10px; border:1px solid #303949; background:#0b1220; color:var(--text); font-weight:600;
}
input[type="number"] { width:100px; }
input::placeholder { color:#6b778d; }

button { appearance:none; border:none; padding:12px 14px; border-radius:10px; font-weight:800; cursor:pointer; letter-spacing:.01em; }
.primary { background:var(--accent); color:#0b1023; }
.secondary { background:#1f2937; color:var(--text); }
.ghost { background:#0b1220; border:1px solid #2a3550; color:#cfe1ff; }
button:disabled { opacity:.55; cursor:not-allowed; }

.pill { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #2a3550; background:#0b1220; color:#9fb5d1; font-size:.8rem; }
label { font-size:.9rem; color:#a8b0bf; }
input[type="range"] { width:160px; }
.rule { border:none; border-top:1px solid #273244; margin:10px 0; }

/* highlight (also defined inline in index.html for cache-proofing) */
#notationOutput .row-item { padding: 2px 6px; border-radius: 6px; }
#notationOutput .row-item.playing { background: #1e293b; }
</style>
</head>
<body>
  <div class="app">

    <!-- Sticky toolbar at the very top -->
    <header class="toolbar">
      <div class="bar">
        <h1>üîî Bell Sequence (diatonic, 1 = highest) + Place Notation Generator</h1>
        <p class="muted">Enter digits 1‚Äì8 (1 is the highest note). Set Place Notation and Stage, then Generate. Playback adds a cover on odd stages only during audio.</p>

        <!-- PLAYER CONTROLS -->
        <div class="row">
          <input id="seq" type="text" placeholder="Digits 1‚Äì8, e.g. 12345678 or 152531" inputmode="numeric" />
          <button id="play" class="primary">‚ñ∂Ô∏è Play</button>
          <button id="stop" class="secondary">‚èπ Stop</button>
          <button id="beep" class="ghost">üîä Test Beep</button>
          <span id="status" class="pill">idle</span>
        </div>

        <div class="row">
          <label>Tempo (BPM) <input id="bpm" type="number" min="30" max="300" value=""></label>
          <label>Strike (s) <input id="len" type="number" min="0.1" max="3" step="0.05" value=""></label>
          <label>Volume <input id="vol" type="range" min="0" max="1" step="0.01" value=""></label>
        </div>

        <hr class="rule">

        <!-- PLACE NOTATION + STAGE -->
        <div class="row">
          <input id="placeNotation" type="text"
                 value=""
                 placeholder="Place Notation (e.g. x12.16.34x)"
                 style="flex:1 1 320px">
          <label>Stage
            <input id="stage" type="number" min="4" max="12" step="1" value="" />
          </label>
          <button id="generate" class="primary">Generate</button>

          <!-- Generated rows playback -->
          <button id="playRows" class="secondary" title="Play generated rows">‚ñ∂Ô∏è Play Rows</button>
          <button id="pauseRows" class="ghost" title="Pause playback">‚è∏ Pause</button>
          <button id="stopRows" class="ghost" title="Stop playback">‚èπ Stop</button>
        </div>
      </div>
    </header>

    <!-- Workspace fills all remaining viewport height -->
    <main class="workspace">
      <div class="panel">
        <div id="notationOutput"><em class="muted">‚Äî nothing generated yet ‚Äî</em></div>
      </div>
    </main>
  </div>

  
<script>
(()=>{var w={stage:6,placeNotation:"x16x16x16x16x16x16",bpm:230,strike:1.1,volume:.25,autoGenerateOnLoad:!1,startHighlightAtRow0:!0};var c=null,h=null,y=[392,349.23,329.63,293.66,261.63,246.94,220,196,174.61,164.81,146.83,130.81];async function D(t,{strike:e=.6,volume:s=.9}={}){if(t<1||t>y.length)return;await k(s),x(s);let a=y[t-1]*1.5,i=Math.max(.05,Math.min(3,e)),r=c?c.currentTime:0,l=c.createOscillator(),o=c.createGain();l.type="sine",l.frequency.value=a;let p=Math.min(.005,i*.1),f=r,E=f+p,B=f+i;o.gain.setValueAtTime(1e-4,f),o.gain.linearRampToValueAtTime(1,E),o.gain.exponentialRampToValueAtTime(1e-4,B),l.connect(o).connect(h),l.start(f),l.stop(B+.01)}async function k(t=.9){(!c||c.state==="closed")&&(c=new(window.AudioContext||window.webkitAudioContext),h=c.createGain(),h.gain.value=Number.isFinite(t)?t:.9,h.connect(c.destination));try{await c.resume()}catch{}return c}function x(t){if(!c||!h)return;let e=c.currentTime;h.gain.setTargetAtTime(Math.max(0,Math.min(1,t)),e,.01)}function N(){if(!c)return;let t=c.currentTime;h.gain.setTargetAtTime(1e-4,t,.02),setTimeout(()=>{try{c.close()}catch{}c=null,h=null},120)}async function $(){if(c&&c.state==="running")try{await c.suspend()}catch{}}async function C(){if(c&&c.state==="suspended")try{await c.resume()}catch{}}function F(t,e,s){let a=c.createOscillator(),i=c.createGain();a.type="sine",a.frequency.value=t;let r=Math.min(.005,s*.1),l=.01,o=e,p=o+r,f=o+s;i.gain.setValueAtTime(1e-4,o),i.gain.linearRampToValueAtTime(1,p),i.gain.exponentialRampToValueAtTime(1e-4,f),a.connect(i).connect(h),a.start(o),a.stop(f+l)}async function V(t,{bpm:e=224,strike:s=.6,volume:a=.9}={}){if(!Array.isArray(t)||!t.length)return;await k(a),x(a);let i=60/Math.max(30,Math.min(300,e)),r=Math.max(.05,Math.min(3,s)),l=c.currentTime+.05;t.forEach((o,p)=>{if(o<1||o>y.length)return;let f=l+p*i,E=1.5*y[o-1];F(E,f,r)})}async function G(){await k();let t=c.currentTime+.02;F(880,t,.25)}function U(t){let e=String(t||"").replace(/\s+/g,"");return e?/^[1-8]+$/.test(e)?e.split("").map(s=>parseInt(s,10)):null:[]}var R="1234567890ET";function d(t){let e=Number(t);return Math.max(4,Math.min(12,Number.isFinite(e)?e:6))}function z(t){console.debug("ROUNDS FOR STAGE!");let e=d(t);return R.substring(0,e)}function _(t){let e=String(t||"").trim();if(!e)return[];let s=new Set([...R,"e","t","E","T"]),a=[],i="",r=()=>{i&&(a.push(i),i="")};for(let l=0;l<e.length;l++){let o=e[l];if(o==="."){r();continue}if(o==="x"||o==="X"){r(),a.push("x");continue}/\s/.test(o)||s.has(o)&&(i+=o==="e"?"E":o==="t"?"T":o)}return r(),a}function A(t){let e=R.indexOf(t);return e>=0?e+1:null}function Q(t,e,s){let a=t.length,i=t.split(""),r=i.slice();if(e==="x"){for(let p=0;p+1<a;p+=2)r[p]=i[p+1],r[p+1]=i[p];return r.join("")}let l=new Set;for(let p of e){let f=A(p);f&&f>=1&&f<=s&&l.add(f)}let o=1;for(;o<=a;){let p=o+1;if(l.has(o)){r[o-1]=i[o-1],o+=1;continue}if(p>a){r[o-1]=i[o-1],o+=1;continue}if(l.has(p)){r[o-1]=i[o-1],o+=1;continue}r[o-1]=i[p-1],r[p-1]=i[o-1],o+=2}return r.join("")}function T({pnString:t,stage:e,maxLeads:s=12}){let a=d(e),i=z(a),r=_(t);if(!r.length)return[i];let l=[i],o=i,p=0;for(;p<s;){for(let f of r)o=Q(o,f,a),l.push(o);if(p+=1,o===i)break}return l}function n(t){let e=document.getElementById(t);if(!e)throw new Error(`Element #${t} not found. Check index.html IDs and cache.`);return e}function W(){let t=new URLSearchParams(location.search),e=t.get("pn")||"",s=t.get("st"),a=s!=null?Number(s):null;return{pn:e,stage:a}}function P({pn:t,stage:e}){let s=new URLSearchParams(location.search);t&&t.trim()?s.set("pn",t.trim()):s.delete("pn"),s.set("st",String(d(e)));let a=`${location.pathname}?${s.toString()}${location.hash}`;history.replaceState(null,"",a)}function X(){n("placeNotation").value||(n("placeNotation").value=w.placeNotation),n("stage").value||(n("stage").value=w.stage),n("bpm").value||(n("bpm").value=w.bpm),n("len").value||(n("len").value=w.strike),n("vol").value||(n("vol").value=w.volume)}function Y(t,e=250){let s;return(...a)=>{clearTimeout(s),s=setTimeout(()=>t(...a),e)}}var I=Y(P,250);function g(t){n("status").textContent=t}function b(){document.querySelectorAll("#notationOutput .row-item.playing").forEach(t=>t.classList.remove("playing"))}function J(t){let e=`#notationOutput .row-item[data-row="${t}"]`,s=document.querySelector(e);if(!s){console.debug("highlightRow: element not found for index",t,"selector:",e);return}b(),s.classList.add("playing"),s.scrollIntoView({block:"nearest",inline:"nearest"})}var M=!1,q=null;function L({playing:t}){n("play").disabled=!!t}function K(){n("play").addEventListener("click",async()=>{if(M)return;let t=U(n("seq").value);if(t===null){g("invalid (use digits 1\u20138)");return}if(!t.length){g("nothing to play");return}let e=Math.max(30,Math.min(300,Number(n("bpm").value)||224)),s=Math.max(.05,Math.min(3,Number(n("len").value)||.6)),a=Math.max(0,Math.min(1,Number(n("vol").value)||.9));M=!0,L({playing:!0}),await V(t,{bpm:e,strike:s,volume:a}),g(`playing (${t.length} notes @ ${e} BPM)`);let i=60/e,r=(t.length*i+.2)*1e3;clearTimeout(q),q=setTimeout(()=>{M=!1,L({playing:!1}),g("idle")},r)}),n("stop").addEventListener("click",()=>{N(),M=!1,clearTimeout(q),L({playing:!1}),g("stopped")}),n("beep").addEventListener("click",async()=>{await G(),g("beep")}),n("vol").addEventListener("input",t=>{let e=Math.max(0,Math.min(1,Number(t.target.value)||.9));x(e)}),n("seq").value="12345678",L({playing:!1})}var m=[],u={playing:!1,paused:!1,abort:!1};function v({playing:t,paused:e}){n("playRows").disabled=!!t&&!e,n("pauseRows").disabled=!t||e,n("stopRows").disabled=!t}function O(t){let e=n("notationOutput");if(!t||!t.length){e.innerHTML='<em class="muted">\u2014 nothing generated \u2014</em>';return}let s=d(n("stage").value);e.innerHTML=t.map((a,i)=>`<div class="row-item" data-row="${i}"><code>${a.slice(0,s)}</code></div>`).join(""),requestAnimationFrame(()=>{})}function Z(){n("placeNotation").addEventListener("input",()=>{I({pn:n("placeNotation").value,stage:n("stage").value})}),n("stage").addEventListener("input",()=>{let t=d(n("stage").value);n("stage").value=t,I({pn:n("placeNotation").value,stage:t})}),n("generate").addEventListener("click",()=>{let t=(n("placeNotation").value||"").trim(),e=d(n("stage").value);n("stage").value=e,m=T({pnString:t,stage:e}),O(m),b(),P({pn:t,stage:e})}),n("playRows").addEventListener("click",async()=>{if(!(u.playing&&!u.paused)){if(!m.length){let t=d(n("stage").value);m=T({pnString:(n("placeNotation").value||"").trim(),stage:t}),O(m),b(),P({pn:n("placeNotation").value,stage:t})}if(m.length){if(u.paused){u.paused=!1,v({playing:!0,paused:!1}),await C();return}u.playing=!0,u.paused=!1,u.abort=!1,v({playing:!0,paused:!1}),et().catch(t=>console.error(t))}}}),n("pauseRows").addEventListener("click",async()=>{!u.playing||u.paused||(u.paused=!0,v({playing:!0,paused:!0}),await $())}),n("stopRows").addEventListener("click",()=>{u.playing&&(u.abort=!0,u.paused=!1,u.playing=!1,v({playing:!1,paused:!1}),N(),b(),g("stopped"))}),v({playing:!1,paused:!1})}function tt(t,e){let s=e%2===0?e:e+1,a=12-s,i=[];for(let r of t){let l=A(r);if(!l||l<1||l>e)continue;let o=a+l;o>=1&&o<=12&&i.push(o)}if(e%2===1){let r=a+s;r>=1&&r<=12&&i.push(r)}return i}function S(t){return new Promise(e=>setTimeout(e,t))}async function j(t,e){let s=0,a=performance.now();for(;s<t;){if(e("abort"))return;for(;e("paused");){if(await S(60),e("abort"))return;a=performance.now()}await S(20);let i=performance.now(),r=(i-a)/1e3;a=i;let o=60/Math.max(30,Math.min(300,Number(n("bpm").value)||224));s+=r/o}}async function et(){let t=d(n("stage").value),e=Math.max(0,Math.min(1,Number(n("vol").value)||.9)),s=a=>a==="abort"?u.abort:a==="paused"?u.paused:u.abort||u.paused;for(let a=0;a<m.length&&!u.abort;a++){for(;u.paused&&(await S(60),!u.abort););if(u.abort)break;J(a),console.debug("Playing row",a,m[a]);let i=m[a],r=tt(i,t);for(let l=0;l<r.length&&!u.abort;l++){for(;u.paused&&(await S(60),!u.abort););if(u.abort)break;let o=Math.max(.05,Math.min(3,Number(n("len").value)||.6));await D(r[l],{strike:o,volume:e}),l<r.length-1&&await j(1,s)}if(g(`row ${a+1}/${m.length}`),a<m.length-1){let l=a%2===0?2:1;await j(l,s)}}b(),u.abort||g("done"),u.playing=!1,u.paused=!1,u.abort=!1,v({playing:!1,paused:!1})}function H(){try{["seq","play","stop","beep","status","bpm","len","vol","placeNotation","stage","generate","notationOutput","playRows","pauseRows","stopRows"].forEach(s=>n(s));let{pn:t,stage:e}=W();if(t&&(n("placeNotation").value=t),e!=null&&(n("stage").value=d(e)),X(),t||e!=null||w.autoGenerateOnLoad){let s=d(n("stage").value);m=T({pnString:(n("placeNotation").value||"").trim(),stage:s}),O(m),b()}K(),Z(),window.addEventListener("resize",()=>requestAnimationFrame(updateBlueTrace)),n("notationOutput").addEventListener("scroll",()=>requestAnimationFrame(updateBlueTrace)),g("idle")}catch(t){console.error(t),alert(t.message+`

Tip: hard-reload (Ctrl+F5 / Cmd+Shift+R) to bust cache.`)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",H,{once:!0}):H();})();

</script>
</body>
</html>